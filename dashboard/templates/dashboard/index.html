{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="container-fluid page-body-wrapper">
  <div class="main-panel">
    <div class="content-wrapper">
      <div class="row">
        <div class="col-sm-6 mb-4 mb-xl-0">
          <div class="d-lg-flex align-items-center">
            <div>
              <h3 class="text-dark font-weight-bold mb-2">مرحبًا، {{ request.user.username }}!</h3>
              <h6 class="font-weight-normal mb-2">آخر تسجيل دخول: {{ request.user.last_login|date:"Y-m-d H:i" }}</h6>
            </div>
          </div>
        </div>
        {% if not is_reception %}
        <div class="col-sm-6">
          <div class="d-flex align-items-center justify-content-md-end">
            <div class="pe-1 mb-3 mb-xl-0">
              <a href="{% url 'financial_report' %}" class="btn btn-outline-inverse-info btn-icon-text">
                تقرير مالي
                <i class="mdi mdi-file-chart btn-icon-append"></i>
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="row mt-4">
        <div class="col-lg-{% if is_reception %}6{% else %}4{% endif %} grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">مواعيد اليوم</h4>
              <h2 class="text-dark font-weight-bold">{{ total_appointments_today }}</h2>
              <a href="{% url 'appointment_list' %}" class="btn btn-primary btn-sm mt-3">عرض المواعيد</a>
            </div>
          </div>
        </div>
        <div class="col-lg-{% if is_reception %}6{% else %}4{% endif %} grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">إجمالي المرضى</h4>
              <h2 class="text-dark font-weight-bold">{{ total_patients }}</h2>
              <a href="{% url 'patient_create' %}" class="btn btn-primary btn-sm mt-3">إضافة مريض</a>
            </div>
          </div>
        </div>
        {% if not is_reception %}
        <div class="col-lg-4 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">إجمالي الإيرادات اليوم</h4>
              <h2 class="text-dark font-weight-bold">{{ total_payments_today }} جنيه</h2>
              <a href="{% url 'payment_list' %}" class="btn btn-primary btn-sm mt-3">عرض الدفعات</a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      {% if not is_reception %}
      <div class="row">
        <div class="col-lg-8 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">إحصائيات الأسبوع الماضي</h4>
              <canvas id="weeklyStatsChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-4 grid-margin stretch-card">
          <div class="card congratulation-bg text-center">
            <div class="card-body pb-0">
              <img src="{% static 'images/faces/face28.png' %}" alt="profile">
              <h2 class="mt-3 text-white mb-3 font-weight-bold">مرحبًا، {{ request.user.username }}</h2>
              <p>لقد قمت بإدارة {{ total_appointments_today }} موعد اليوم!</p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    <footer class="footer">
      <div class="footer-wrap">
        <div class="d-sm-flex justify-content-center justify-content-sm-between">
          <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">{{ footer_text|default:"Copyright &copy; 2025 All rights reserved." }}</span>
          <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Powered by <a href="https://www.bootstrapdash.com/" target="_blank">Bootstrap Dashboard</a></span>
        </div>
      </div>
    </footer>
  </div>
</div>
<script src="{% static 'vendors/chart.js/Chart.min.js' %}"></script>
<script>
  $(document).ready(function() {
    {% if not is_reception %}
    var ctx = document.getElementById('weeklyStatsChart').getContext('2d');
    var weeklyStatsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['اليوم', '-1', '-2', '-3', '-4', '-5', '-6'],
        datasets: [
          {
            label: 'المواعيد',
            data: {{ appointments_by_day|safe }},
            borderColor: '#4caf50',
            fill: false
          },
          {
            label: 'الإيرادات',
            data: {{ revenue_by_day|safe }},
            borderColor: '#2196f3',
            fill: false
          },
          {
            label: 'المصروفات',
            data: {{ expenses_by_day|safe }},
            borderColor: '#f44336',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    {% endif %}
  });
</script>
{% endblock %}